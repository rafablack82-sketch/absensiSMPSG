<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Absensi Online</title>
</head>
<body>
  <h2>Absensi Online</h2>
  <form id="absensiForm">
    <label>Nama Lengkap:</label><br>
    <input type="text" id="nama" required><br><br>

    <label>Kelas:</label><br>
    <input type="text" id="kelas" required><br><br>

    <button type="submit">Absen Sekarang</button>
  </form>

  <script>
    // URL formResponse dari Form Bapak
    const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSfce9hxm3mzRmnQfudfxSFrWiazNOcnVKYieDW8ITbPKYyC7g/formResponse";

    // Entry IDs dari pre-filled link
    const entryNama = "entry.1650028786";
    const entryKelas = "entry.2089936329";
    const entryLat   = "entry.1532119486";
    const entryLon   = "entry.1697944181";

    // Koordinat sekolah (ganti dengan koordinat yang benar)
    const sekolahLat = -7.1575;     // contoh, ganti sesuai lokasi sekolah
    const sekolahLon = 112.6558;    // contoh, ganti sesuai lokasi sekolah
    const radiusMaks = 100;         // meter

    function hitungJarak(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // meter
      const φ1 = lat1 * Math.PI/180;
      const φ2 = lat2 * Math.PI/180;
      const Δφ = (lat2 - lat1) * Math.PI/180;
      const Δλ = (lon2 - lon1) * Math.PI/180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    document.getElementById("absensiForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const nama = document.getElementById("nama").value;
      const kelas = document.getElementById("kelas").value;

      if (!nama || !kelas) {
        alert("Mohon isi Nama dan Kelas terlebih dahulu.");
        return;
      }

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          const latitude = pos.coords.latitude;
          const longitude = pos.coords.longitude;

          const jarak = hitungJarak(latitude, longitude, sekolahLat, sekolahLon);

          if (jarak > radiusMaks) {
            alert("❌ Anda berada di luar area sekolah. Jarak: " + Math.round(jarak) + " m");
            return;
          }

          const formData = new FormData();
          formData.append(entryNama, nama);
          formData.append(entryKelas, kelas);
          formData.append(entryLat, latitude);
          formData.append(entryLon, longitude);

          fetch(formURL, {
            method: "POST",
            mode: "no-cors",
            body: formData
          }).then(() => {
            alert("✅ Absensi berhasil dikirim! Jarak Anda dari sekolah: " + Math.round(jarak) + " m");
            document.getElementById("absensiForm").reset();
          }).catch((err) => {
            alert("❌ Gagal mengirim absensi: " + err);
          });
        }, function(error) {
          alert("Tidak bisa mendapatkan lokasi: " + error.message);
        });
      } else {
        alert("Browser Anda tidak mendukung geolokasi.");
      }
    });
  </script>

</body>
</html>
